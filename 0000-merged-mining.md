- Feature Name: merged-mining
- Start Date: 2018-12-11
- RFC PR: (leave this empty)
- Hathor Issue: (leave this empty)
- Author: Pedro Henrique Santos Ferreira

# Summary
[summary]: #summary

Enable miners to mine Hathor blocks while they are also mining Bitcoin.

# Motivation
[motivation]: #motivation

The motivation is that giving the possibility to execute merged mining attracts more people (mainly mining pools) to also mine Hathor blocks, increasing the hash power of our network. With a higher hash power, we have more security against 51% attacks, so more incentive for people to use it.

# Guide-level explanation
[guide-level-explanation]: #guide-level-explanation

First, the only thing we need from Bitcoin is a place in the block to add arbitrary data, that does not influence when the block is propagate in the network. This place is the coinbase transaction.

We will need to generate a block that will be valid in both networks when propagated (Hathor and Bitcoin). This block will be called AuxPOW block. AuxPOW comes from Auxiliary Proof-of-work.

The Bitcoin blockchain will be called Parent Blockchain (the one that has the biggest difficulty) and the Hathor blockchain will be called Auxiliary Blockchain (the one that has the smallest difficulty)

We start the process creating the AuxPOW block, that has 4 steps:

1. We get the Bitcoin candidate block with the transactions
2. We get the Hathor candidate block
3. We hash the Hathor candidate block in bytes (32 bytes)
4. We add this hash to the Bitcoin coinbase transaction, that changes the merkle root hash (making sure the bitcoin block has to be pre-mined with the Hathor hash before)

The work to solve this AuxPOW block is sent to be mined.

We have 3 possibilities:

1. The hash found does not solve any of pow from neither Bitcoin or Hathor block, so we just increase the nonce and continue the hash process.
2. The hash found solves the Hathor pow and does not solves Bitcoin pow, so we just propagate the AuxPOW block in the Hathor network.
  - We must add some data from the AuxPOW block to the Hathor block to confirm that the work was done
  - We add the AuxPOW block header and the coinbase transaction to validate that the work is valid, that solves Hathor pow and that the coinbase transaction is linked to the Hathor block being propagated.
3. The hash found solves the pow from both blocks. In that case we just normally propagate bitcoin block and follow the steps in possibility 2 to propagate Hathor block.


# Reference-level explanation
[reference-level-explanation]: #reference-level-explanation

- Creating the AuxPOW block:
  - #TODO should we add how to get bitcoin candidate block?
  - To get Hathor candidate block we just need to call `manager.get_mining_block().get_struct()` -> bytes
  - Then we hash the Hathor candidate block in bytes `hashlib.sha256(candidate_block_bytes).digest()` -> 32 bytes hash

To validate that the block generated by merged mining is valid we must:
  - Add the AuxPOW block header and coinbase transaction to the Hathor block `merge_mining_block` field #TODO should we call like that or maybe a generic field `aux_data`, so it can be used for other purposes also?
  - Calculate the hash of the AuxPOW block header to see if it solves the Hathor pow
  - Using the coinbase transaction that has the Hathor sha256 and the merkle hash in the AuxPOW block header we can validate that the the Hathor candidate block was linked to the AuxPOW block before the work was done, so it's valid #TODO how to do this validation with merkle hash and coinbase tx?


# Rationale and alternatives
[rationale-and-alternatives]: #rationale-and-alternatives

- We are using the same specifications of Namecoin and Elastos, what is good because people are already used to it.
- Merge mining is good in terms of increasing hash power of the network and also good for marketing, since we can argue that you are not using any other energy to mine our blocks.

# Unresolved questions
[unresolved-questions]: #unresolved-questions

- Should we issue the same quantity of tokens for blocks mined with and without merge mining?
- Should we prepare ourselves to allow merged mining in our platform us being the parent blockchain? We would need a place to add arbitrary data that does not influence when propagating to the network.

# Future possibilities
[future-possibilities]: #future-possibilities

- In the future we may support mine blocks in more than one auxiliary blockchain in the same time, for that we would need to update the code to support it #TODO